
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Kronos driven co-simulation &#8212; OpenSCADA 1.0 documentation</title>
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Advanced Topics" href="advanced_topics.html" />
    <link rel="prev" title="Simulating Physical Systems" href="building_physical_simulations.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>OpenSCADA 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>Kronos driven co-simulation</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="building_physical_simulations.html">Simulating Physical Systems</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="advanced_topics.html">Advanced Topics</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="kronos-driven-co-simulation">
<h1>Kronos driven co-simulation<a class="headerlink" href="#kronos-driven-co-simulation" title="Permalink to this headline">¶</a></h1>
<p>In this section, we discuss how Kronos can be used to run time synchronized OpenSCADA PLCs and physical system simulations. This discussion is based on the <a class="reference external" href="https://github.com/Vignesh2208/OpenSCADA/tree/master/examples/inverted_pendulum">inverted_pendulum</a> example included with the installation. We will refer the script <a class="reference external" href="https://github.com/Vignesh2208/OpenSCADA/tree/master/examples/inverted_pendulum/simulation.py">simulation.py</a> in the rest of this discussion.</p>
<div class="section" id="initializing-the-co-simulation">
<h2>Initializing the co-simulation<a class="headerlink" href="#initializing-the-co-simulation" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">The first step in running a time synchronized co-simulation involves creating a physical system simulator object. As discussed in Section, Simulating Physical Systems, this object must inherit from PhysicalSystemSim abstract class defined in <a class="reference external" href="https://github.com/Vignesh2208/OpenSCADA/tree/master/contrib/physical_system_sim.py">physical_system_sim.py</a>. In the running example, a class called PendulumSimulator is implemented and an object of this class is instantiated and used for this purpose:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pendulum_sim</span> <span class="o">=</span> <span class="n">PendulumSimulator</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p class="first">The next step involves initializing an EmulationDriver object (defined in <a class="reference external" href="https://github.com/Vignesh2208/OpenSCADA/tree/master/contrib/emulation_driver.py">emulation_driver.py</a>) and register the previously created physical system simulator object. This step also assumes that Kronos module is installed and loaded:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emulation</span> <span class="o">=</span> <span class="n">EmulationDriver</span><span class="p">(</span><span class="n">number_dilated_nodes</span><span class="o">=</span><span class="n">num_dilated_nodes</span><span class="p">,</span> \
                            <span class="n">is_virtual</span><span class="o">=</span><span class="n">is_virtual</span><span class="p">,</span> \
                            <span class="n">n_insns_per_round</span><span class="o">=</span><span class="n">num_insns_per_round</span><span class="p">,</span>
                            <span class="n">rel_cpu_speed</span><span class="o">=</span><span class="n">rel_cpu_speed</span><span class="p">,</span> \
                            <span class="n">physical_system_sim_driver</span><span class="o">=</span><span class="n">pendulum_sim</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<p>The emulation driver class takes in some Kronos specific arguments which are briefly described here. For a more thorough discussion, please refer <a class="reference external" href="https://github.com/Vignesh2208/Kronos">Kronos</a> documentation.</p>
<blockquote>
<div><ul class="simple">
<li><strong>is_virtual</strong>: If True Kronos is initialized</li>
<li><strong>physical_system_driver</strong>: An object which implements PhysicalSystemSim abstract class defined in contib/physical_system_sim.py. If it is None, then it denotes that this co-simulation has no attached physical simulator.</li>
<li><strong>number_dilated_nodes</strong>: Ignored unless is_virtual is True. Denotes number of nodes under Kronos control. Note that each PLC’s CPU counts as a separate node. So if there are two PLCs each with 2 CPUs, then there are 4 dilated_nodes in total.</li>
<li><strong>rel_cpu_speed</strong>: Ignored unless is_virtual is True. Denotes the relative cpu speed / (equivalent to TDF). In Kronos it represents the number of instructions that can be executed in 1ns of virtual time.</li>
<li><strong>n_insns_per_round</strong>: Number of instructions to execute per round. When divided by the rel_cpu_speed, it denotes amount of time the co-simulation would advance in one-round. In the running example, n_insns_per_round is 1000000 and rel_cpu_speed is 1 which implies that in each round, the co-simulation would run for 1000000 ns or 1ms.</li>
</ul>
</div></blockquote>
<ul>
<li><p class="first">The next step involves starting the GRPC server to initialize all memory mapped files and serve as interface to query PLCs which would be subsequently started:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="s2">&quot;Starting PC GRPC Server ...&quot;</span>
<span class="n">grpc_server_pid</span> <span class="o">=</span> <span class="n">start_grpc_server</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">plc_spec_dir</span><span class="p">,</span> <span class="n">fd1</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The GRPC server does not count as a dilated node and should not be added to Kronos’s control</p>
</div>
</div>
<div class="section" id="starting-dilated-processes">
<h2>Starting dilated processes<a class="headerlink" href="#starting-dilated-processes" title="Permalink to this headline">¶</a></h2>
<p>In this subsection, we discuss the next stage of building a time synchronized co-simulation which involves launching PLCs, communication modules and HMI clients and adding them to Kronos’s control. The rest of this discussion assumes that Kronos is installed and loaded and the previous stage is complete.</p>
<p>To launch any process under Kronos’s control, it has to launched by a <strong>tracer</strong> binary which ships with Kronos installation. For example, let us consider a simple command with arguments <strong>ls -al</strong>. It can be added to Kronos’s control as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tracer</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;ls -al&quot;</span> <span class="o">-</span><span class="n">r</span> <span class="o">&lt;</span><span class="n">rel_cpu_speed</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">n</span> <span class="o">&lt;</span><span class="n">n_insns_per_round</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Using the tracer binary, OpenSCADA PLCs, communication modules and HMIs are added to Kronos’ control. The relevant portions of this stage from the running example are included here:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="s2">&quot;Starting PLC ...&quot;</span>
<span class="n">plc_pid</span> <span class="o">=</span> <span class="n">start_plc</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">plc_spec_file</span><span class="p">,</span> <span class="n">is_virtual</span><span class="p">,</span> <span class="n">rel_cpu_speed</span><span class="p">,</span> \
<span class="n">num_insns_per_round</span><span class="p">,</span> <span class="n">fd2</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">&quot;Starting Modbus Comm module ...&quot;</span>
<span class="n">comm_module_pid</span> <span class="o">=</span> <span class="n">start_comm_module</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">plc_spec_file</span><span class="p">,</span> \
<span class="n">args</span><span class="o">.</span><span class="n">comm_module_bind_ip</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">comm_module_listen_port</span><span class="p">,</span> \
<span class="n">args</span><span class="o">.</span><span class="n">comm_module_attached_resource</span><span class="p">,</span> <span class="n">is_virtual</span><span class="p">,</span> <span class="n">rel_cpu_speed</span><span class="p">,</span> \
<span class="n">num_insns_per_round</span><span class="p">,</span> <span class="n">fd3</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">&quot;Starting HMI ...&quot;</span>
<span class="n">example_hmi_pid</span> <span class="o">=</span> <span class="n">start_example_hmi</span><span class="p">(</span><span class="n">is_virtual</span><span class="p">,</span> <span class="n">rel_cpu_speed</span><span class="p">,</span> \
<span class="n">num_insns_per_round</span><span class="p">,</span> <span class="n">fd4</span><span class="p">)</span>
</pre></div>
</div>
<p>Subsequently, the next step involves waiting for all started process to register themselves with Kronos:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Wait until all processes have started and registered themselves</span>
<span class="n">emulation</span><span class="o">.</span><span class="n">wait_for_initialization</span><span class="p">()</span>
</pre></div>
</div>
<p>After the completion of this stage, the experiment is frozen and ready to run in a time synchronized fashion.</p>
</div>
<div class="section" id="running-the-co-simulation">
<h2>Running the co-simulation<a class="headerlink" href="#running-the-co-simulation" title="Permalink to this headline">¶</a></h2>
<p>The co-simulation can be run using the emulation_driver object. It provides a method <strong>run_for(time_secs)</strong> which takes in as input the number of virtual time seconds to run. In running_example, since the co-simulation advances by 1ms each round (rel_cpu_speed is 1.0 and n_insns_per_round is 1000000), the argument provided to the <strong>run_for</strong> method is implicitly converted into the number of rounds to run. In each round, all the dilated processes are triggered and <strong>progress</strong> method of the physical system simulator object is invoked once:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">total_time_elapsed</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="k">while</span> <span class="n">total_time_elapsed</span> <span class="o">&lt;=</span> <span class="n">run_time</span><span class="p">:</span>
        <span class="c1"># Run for 10ms or 10 rounds.</span>
        <span class="n">emulation</span><span class="o">.</span><span class="n">run_for</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">total_time_elapsed</span> <span class="o">+=</span> <span class="mf">0.01</span>
        <span class="k">if</span> <span class="n">is_virtual</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Time Elapsed: &quot;</span><span class="p">,</span> <span class="n">total_time_elapsed</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="section" id="stopping-the-co-simulation">
<h2>Stopping the co-simulation<a class="headerlink" href="#stopping-the-co-simulation" title="Permalink to this headline">¶</a></h2>
<p>The co-simulation can be stopped by invoking the <strong>stop_exp()</strong> method provided by the emulation_driver:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emulation</span><span class="o">.</span><span class="n">stop_exp</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="building_physical_simulations.html">Simulating Physical Systems</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="advanced_topics.html">Advanced Topics</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Vignesh Babu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>