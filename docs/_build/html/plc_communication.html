
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>PLC Communication &#8212; OpenSCADA 1.0 documentation</title>
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Simulating Physical Systems" href="building_physical_simulations.html" />
    <link rel="prev" title="PLC I/O" href="plc_io.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>OpenSCADA 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>PLC Communication</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="plc_io.html">PLC I/O</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="building_physical_simulations.html">Simulating Physical Systems</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="plc-communication">
<h1>PLC Communication<a class="headerlink" href="#plc-communication" title="Permalink to this headline">¶</a></h1>
<p>OpenSCADA ships with a modbus communication module which can be attached to a specific CPU in a PLC. The built-in modbus communication module connects to the input memory of the CPU and RAM memory of the PLC. It listens for modbus requests to read from the input registers and read/write to the RAM memory. A modified <a class="reference external" href="https://github.com/Vignesh2208/OpenSCADA/tree/master/contrib/libmodbus">libmodbus</a> library included with the repository can be used to build <strong>hmi</strong>  clients which send modbus requests to the communication module.</p>
<div class="section" id="starting-the-modbus-communication-module">
<h2>Starting the Modbus Communication Module<a class="headerlink" href="#starting-the-modbus-communication-module" title="Permalink to this headline">¶</a></h2>
<p>The built-in modbus communication module used the CommModule Interface defined <a class="reference external" href="https://github.com/Vignesh2208/OpenSCADA/tree/master/src/pc_emulator/ext_modules/include/comm_module.h">here</a>. In the Advanced Topics section we will describe how this interface can be used to build more complex communication modules.</p>
<p>The simple modbus communication module included with the installation can be started with the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modbus_comm_module</span> <span class="p">[</span><span class="n">Options</span> <span class="p">[</span><span class="o">-</span><span class="n">ipr</span><span class="p">]]</span> <span class="o">-</span><span class="n">f</span> <span class="o">&lt;</span><span class="n">path_plc_spec_prototxt</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>where the following options are optional:</p>
<blockquote>
<div><ul class="simple">
<li>-i: IP address to bind to. Default is localhost</li>
<li>-p: Port to listen on. Default is 1502</li>
<li>-r: Resource Name/CPU Name to attach to. This CPU must be present in the PLC.</li>
</ul>
</div></blockquote>
<p>This command starts a modus server listening on at the specified ip address, port and attaches creates a memory mapped file of the PLC’s RAM and the CPU’s input memory if not already present. If the PLC has already been started, it just attaches to the already created memory mapped files.</p>
</div>
<div class="section" id="illustration">
<h2>Illustration<a class="headerlink" href="#illustration" title="Permalink to this headline">¶</a></h2>
<p>An example <strong>hmi</strong> client is included <a class="reference external" href="https://github.com/Vignesh2208/OpenSCADA/tree/master/examples/inverted_pendulum/hmi.cc">here</a>. It uses a slightly modified libmodbus library which is documented <a class="reference external" href="http://libmodbus.org/documentation/">here</a>. The example <strong>hmi</strong> client sends a modbus read request every 100 milliseconds to read from input registers 0 to 3. In Modbus terminology, each register is 2 bytes and thus register 0 refers to input memory bytes 0 and 1:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">reads</span> <span class="n">registers</span> <span class="n">starting</span> <span class="n">at</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ending</span> <span class="n">at</span> <span class="mi">3</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span> <span class="n">registers</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="ow">and</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">total</span> <span class="n">of</span> <span class="mi">6</span> <span class="nb">bytes</span>
<span class="n">rc</span> <span class="o">=</span> <span class="n">modbus_read_input_registers</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">input_mem_registers</span><span class="p">);</span>
</pre></div>
</div>
<p>From the read input registers, it extracts floating point value (of size 4 bytes) starting from byte number 1:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">input_mem_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">input_mem_registers</span><span class="p">;</span>
<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_theta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_mem_bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sizeof</span><span class="p">(</span><span class="nb">float</span><span class="p">));</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">input_mem_registers which is a (unit16_t <a href="#id3"><span class="problematic" id="id4">*</span></a>) array needs to casted into a (unit8_t <a href="#id5"><span class="problematic" id="id6">*</span></a>) array to interpret read values as bytes instead of registers.</p>
</div>
<p>Further examples on how to design clients to write values can be found <a class="reference external" href="https://github.com/Vignesh2208/OpenSCADA/tree/master/contrib/libmodbus/tests">here</a>.</p>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="plc_io.html">PLC I/O</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="building_physical_simulations.html">Simulating Physical Systems</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Vignesh Babu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>